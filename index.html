<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Студенческая практика</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }
    #form-section, #teacher-panel { margin-bottom: 20px; }
    label { display: inline-block; width: 150px; margin-bottom: 5px; }
    input[type="text"], select { width: 200px; }
    button { margin-right: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
    th { background-color: #eee; }
    .actions-btn { margin-right: 5px; }
  </style>
</head>
<body>
  <h1>Студенческая практика</h1>

  <div id="form-section">
    <h2>Форма студента</h2>
    <form id="studentForm">
      <label>ФИО: <input type="text" id="fio" required></label><br>
      <label>Курс: <input type="text" id="course" required></label><br>
      <label>Группа: <input type="text" id="group" required></label><br>
      <label>База: <input type="text" id="base"></label><br>
      <label>Адрес: <input type="text" id="address"></label><br>
      <label>Тел. базы: <input type="text" id="phoneBase"></label><br>
      <label>Тел. студента: <input type="text" id="phoneStudent"></label><br>
      <label>Руководитель: <input type="text" id="supervisor"></label><br>
      <label>Вид практики: <input type="text" id="practiceType"></label><br>
      <button type="submit">Добавить студента</button>
    </form>
  </div>

  <div id="teacher-panel">
    <h2>Панель преподавателя</h2>
    <div>
      <input type="text" id="searchName" placeholder="Поиск по ФИО">
      <select id="filterCourse">
        <option value="">Все курсы</option>
      </select>
      <select id="filterGroup">
        <option value="">Все группы</option>
      </select>
      <select id="filterPractice">
        <option value="">Все виды практики</option>
      </select>
      <button id="btnExport">Экспорт JSON</button>
      <button id="btnImport">Импорт JSON</button>
      <input type="file" id="fileInput" accept=".json" style="display:none">
    </div>
    <table id="studentTable">
      <thead>
        <tr>
          <th>ФИО</th>
          <th>Курс</th>
          <th>Группа</th>
          <th>База</th>
          <th>Адрес</th>
          <th>Тел. базы</th>
          <th>Тел. студента</th>
          <th>Руководитель</th>
          <th>Вид практики</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const SHEET_URL = 'https://script.google.com/macros/s/AKfycbwXzOh6H8OeY8KapfDP1LQTE4ytz_DlGdGBNeTkR6o0266Tn8MpCjnvOeSqV6zItwADXQ/exec';
    let students = [];

    // Fetch students from Google Sheets on load
    function fetchStudents() {
      fetch(SHEET_URL)
        .then(response => response.json())
        .then(data => {
          students = data;
          updateFilters();
          updateTable();
        })
        .catch(error => console.error('Error fetching students:', error));
    }

    // Add new student via form
    document.getElementById('studentForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const newStudent = {
        fio: document.getElementById('fio').value,
        course: document.getElementById('course').value,
        group: document.getElementById('group').value,
        base: document.getElementById('base').value,
        address: document.getElementById('address').value,
        phoneBase: document.getElementById('phoneBase').value,
        phoneStudent: document.getElementById('phoneStudent').value,
        supervisor: document.getElementById('supervisor').value,
        practiceType: document.getElementById('practiceType').value
      };
      fetch(SHEET_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(newStudent)
      })

.then(response => {
        if (!response.ok) throw new Error('Ошибка при отправке данных');
        return response.json();
      })
      .then(data => {
        students.push(newStudent);
        updateFilters();
        updateTable();
        document.getElementById('studentForm').reset();
      })
      .catch(error => console.error('Error adding student:', error));
    });

    // Update filter dropdowns
    function updateFilters() {
      const courseSet = new Set();
      const groupSet = new Set();
      const practiceSet = new Set();
      students.forEach(s => {
        if (s.course) courseSet.add(s.course);
        if (s.group) groupSet.add(s.group);
        if (s.practiceType) practiceSet.add(s.practiceType);
      });
      const filterCourse = document.getElementById('filterCourse');
      const filterGroup = document.getElementById('filterGroup');
      const filterPractice = document.getElementById('filterPractice');
      filterCourse.length = 1;
      filterGroup.length = 1;
      filterPractice.length = 1;
      courseSet.forEach(course => {
        const option = document.createElement('option');
        option.value = course;
        option.text = course;
        filterCourse.add(option);
      });
      groupSet.forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        option.text = group;
        filterGroup.add(option);
      });
      practiceSet.forEach(pt => {
        const option = document.createElement('option');
        option.value = pt;
        option.text = pt;
        filterPractice.add(option);
      });
    }

    // Update table display based on filters and search
    function updateTable() {
      const tableBody = document.querySelector('#studentTable tbody');
      tableBody.innerHTML = '';
      const search = document.getElementById('searchName').value.toLowerCase();
      const filterCourse = document.getElementById('filterCourse').value;
      const filterGroup = document.getElementById('filterGroup').value;
      const filterPractice = document.getElementById('filterPractice').value;

      students.forEach((student, index) => {
        if ((search === '' || student.fio.toLowerCase().includes(search)) &&
            (filterCourse === '' || student.course === filterCourse) &&
            (filterGroup === '' || student.group === filterGroup) &&
            (filterPractice === '' || student.practiceType === filterPractice)
           ) {
          const row = tableBody.insertRow();
          row.setAttribute('data-index', index);
          row.insertCell().textContent = student.fio;
          row.insertCell().textContent = student.course;
          row.insertCell().textContent = student.group;
          row.insertCell().textContent = student.base;
          row.insertCell().textContent = student.address;
          row.insertCell().textContent = student.phoneBase;
          row.insertCell().textContent = student.phoneStudent;
          row.insertCell().textContent = student.supervisor;
          row.insertCell().textContent = student.practiceType;
          const actionsCell = row.insertCell();
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Редактировать';
          editBtn.className = 'actions-btn';
          editBtn.onclick = () => editStudent(index);
          actionsCell.appendChild(editBtn);
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Удалить';
          deleteBtn.className = 'actions-btn';
          deleteBtn.onclick = () => deleteStudent(index);
          actionsCell.appendChild(deleteBtn);
        }
      });
    }

    // Search and filter events
    document.getElementById('searchName').addEventListener('input', updateTable);
    document.getElementById('filterCourse').addEventListener('change', updateTable);
    document.getElementById('filterGroup').addEventListener('change', updateTable);
    document.getElementById('filterPractice').addEventListener('change', updateTable);

// Delete student (client-side only)
    function deleteStudent(index) {
      if (confirm('Удалить эту запись?')) {
        students.splice(index, 1);
        updateFilters();
        updateTable();
      }
    }

    // Edit student (client-side only)
    function editStudent(index) {
      const tableBody = document.querySelector('#studentTable tbody');
      const row = tableBody.querySelector(tr[data-index='${index}']);
      if (!row) return;
      const cells = row.cells;
      if (!row.classList.contains('editing')) {
        row.classList.add('editing');
        // Replace cells with input fields
        for (let i = 0; i < cells.length - 1; i++) {
          const cell = cells[i];
          const value = cell.textContent;
          cell.innerHTML = <input type="text" value="${value}">;
        }
        // Change buttons
        const actionsCell = cells[cells.length - 1];
        actionsCell.innerHTML = '';
        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'Сохранить';
        saveBtn.className = 'actions-btn';
        saveBtn.onclick = () => {
          const inputs = row.querySelectorAll('input');
          if (inputs.length === cells.length - 1) {
            students[index] = {
              fio: inputs[0].value,
              course: inputs[1].value,
              group: inputs[2].value,
              base: inputs[3].value,
              address: inputs[4].value,
              phoneBase: inputs[5].value,
              phoneStudent: inputs[6].value,
              supervisor: inputs[7].value,
              practiceType: inputs[8].value
            };
            row.classList.remove('editing');
            updateFilters();
            updateTable();
          }
        };
        actionsCell.appendChild(saveBtn);
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Отмена';
        cancelBtn.className = 'actions-btn';
        cancelBtn.onclick = () => {
          row.classList.remove('editing');
          updateTable();
        };
        actionsCell.appendChild(cancelBtn);
      }
    }

    // Export JSON of students
    document.getElementById('btnExport').addEventListener('click', function() {
      const dataStr = JSON.stringify(students, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      const link = document.createElement('a');
      link.href = dataUri;
      link.download = 'students.json';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Import JSON of students
    document.getElementById('btnImport').addEventListener('click', function() {
      document.getElementById('fileInput').click();
    });
    document.getElementById('fileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (Array.isArray(imported)) {
            students = imported;
            updateFilters();
            updateTable();
          } else {
            alert('Неверный формат JSON');
          }
        } catch (err) {
          alert('Ошибка чтения JSON');
        }
      };
      reader.readAsText(file);
    });

    // Initial load
    fetchStudents();
  </script>

</body>
</html>